name: Build Multi-Arch APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: ['arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Build APK for ${{ matrix.abi }}
      run: |
        ./gradlew assembleDebug -PAAB_SPLIT_ENABLE=true \
          -PAAB_SPLIT_LIST="${{ matrix.abi }}"
    
    - name: Rename APK
      run: |
        mv app/build/outputs/apk/debug/*.apk \
           app/build/outputs/apk/debug/LiteRead-${{ matrix.abi }}-debug.apk
    
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: apk-${{ matrix.abi }}
        path: app/build/outputs/apk/debug/LiteRead-${{ matrix.abi }}-debug.apk
        retention-days: 30

  build-universal-apk:
    runs-on: ubuntu-latest
    needs: build-apk
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Build Universal APK (Debug)
      run: ./gradlew assembleDebug
    
    - name: Upload Universal Debug APK
      uses: actions/upload-artifact@v3
      with:
        name: universal-apk-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
